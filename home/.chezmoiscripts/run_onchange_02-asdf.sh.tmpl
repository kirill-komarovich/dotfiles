#!/bin/bash

set -eufo pipefail

{{ $asdf_version := "0.10.2 " -}}
{{ $asdf_dir := "~/.asdf" -}}

if [[ ! -d {{ $asdf_dir }} ]]; then
  git clone https://github.com/asdf-vm/asdf.git {{ $asdf_dir }} --branch v{{ $asdf_version }}
fi

{{ $sudo := "sudo " -}}
{{ if eq .chezmoi.username "root" -}}
{{   $sudo = "" -}}
{{ end -}}

asdf={{ $asdf_dir }}/bin/asdf
plugins=$($asdf plugin list)

if [[ ! $plugins =~ "ruby" ]]; then
  {{ $ruby_packages := list
    "autoconf"
    "bison"
    "patch"
    "build-essential"
    "libssl-dev"
    "libyaml-dev"
    "libreadline6-dev"
    "zlib1g-dev"
    "libgmp-dev"
    "libncurses5-dev"
    "libffi-dev"
    "libgdbm6"
    "libgdbm-dev"
    "libdb-dev"
    "uuid-dev"
  -}}

  $asdf plugin add ruby https://github.com/asdf-vm/asdf-ruby.git

  {{ $sudo }}apt-get install -y {{ $ruby_packages | join " " }}

  $asdf install ruby latest
  $asdf global ruby latest
fi
